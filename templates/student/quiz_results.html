<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Results - {{ quiz.title }} - SenseLearn</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-slate-50 min-h-screen">
    <div class="max-w-6xl mx-auto p-6">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-sm border border-slate-200 p-6 mb-6">
            <div class="flex items-center justify-between mb-4">
                <div>
                    <h1 class="text-3xl font-bold text-slate-800">{{ quiz.title }}</h1>
                    {% if quiz.description %}
                    <p class="text-slate-600 mt-2">{{ quiz.description }}</p>
                    {% endif %}
                </div>
                <button onclick="window.location.href='/student/dashboard/courses'" class="px-4 py-2 bg-slate-200 text-slate-700 rounded-lg hover:bg-slate-300 transition">
                    <i class="fas fa-arrow-left mr-2"></i>Back to Courses
                </button>
            </div>
            
            <!-- Score Summary -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mt-6">
                <div class="bg-gradient-to-br from-emerald-500 to-emerald-600 rounded-lg p-4 text-white">
                    <div class="text-sm opacity-90">Your Score</div>
                    <div class="text-3xl font-bold mt-1">{{ "%.1f"|format(attempt.score) if attempt.score else 0 }}%</div>
                </div>
                <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg p-4 text-white">
                    <div class="text-sm opacity-90">Points Earned</div>
                    <div class="text-3xl font-bold mt-1">{{ "%.1f"|format(attempt.total_points) if attempt.total_points else 0 }} / {{ "%.1f"|format(attempt.max_points) if attempt.max_points else 0 }}</div>
                </div>
                <div class="bg-gradient-to-br {% if attempt.is_passing() %}from-green-500 to-green-600{% else %}from-red-500 to-red-600{% endif %} rounded-lg p-4 text-white">
                    <div class="text-sm opacity-90">Status</div>
                    <div class="text-2xl font-bold mt-1">
                        {% if attempt.is_passing() %}
                            <i class="fas fa-check-circle mr-2"></i>Passed
                        {% else %}
                            <i class="fas fa-times-circle mr-2"></i>Failed
                        {% endif %}
                    </div>
                </div>
                <div class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-lg p-4 text-white">
                    <div class="text-sm opacity-90">Passing Score</div>
                    <div class="text-3xl font-bold mt-1">{{ quiz.passing_score if quiz.passing_score else 'N/A' }}%</div>
                </div>
            </div>
            
            <!-- Attempt Info -->
            <div class="mt-6 pt-6 border-t border-slate-200">
                <div class="grid grid-cols-2 gap-4 text-sm">
                    <div>
                        <span class="text-slate-500">Started:</span>
                        <span class="ml-2 font-medium text-slate-800">{{ attempt.started_at.strftime('%Y-%m-%d %H:%M:%S') if attempt.started_at else 'N/A' }}</span>
                    </div>
                    <div>
                        <span class="text-slate-500">Submitted:</span>
                        <span class="ml-2 font-medium text-slate-800">{{ attempt.submitted_at.strftime('%Y-%m-%d %H:%M:%S') if attempt.submitted_at else 'N/A' }}</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Answers Review -->
        <div class="bg-white rounded-lg shadow-sm border border-slate-200 p-6">
            <h2 class="text-2xl font-bold text-slate-800 mb-6">
                <i class="fas fa-list-check mr-2"></i>Question Review
            </h2>
            
            <div id="answers-container" class="space-y-6">
                <!-- Answers will be loaded here via JavaScript -->
                <div class="text-center py-12">
                    <i class="fas fa-spinner fa-spin text-4xl text-slate-400 mb-4"></i>
                    <p class="text-slate-600">Loading answers...</p>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        const attemptId = {{ attempt.id }};
        
        document.addEventListener('DOMContentLoaded', async function() {
            await loadQuizResults();
        });
        
        async function loadQuizResults() {
            try {
                const response = await fetch(`/quiz/api/attempts/${attemptId}`);
                const data = await response.json();
                
                if (data.success) {
                    renderAnswers(data.answers);
                } else {
                    alert(data.error || 'Failed to load quiz results');
                }
            } catch (error) {
                console.error('Error loading quiz results:', error);
                alert('Error loading quiz results. Please try again.');
            }
        }
        
        function renderAnswers(answers) {
            const container = document.getElementById('answers-container');
            container.innerHTML = '';
            
            answers.forEach((answer, index) => {
                const answerDiv = document.createElement('div');
                answerDiv.className = 'border-2 rounded-lg p-6 ' + (answer.is_correct ? 'border-green-300 bg-green-50' : 'border-red-300 bg-red-50');
                
                let answerHtml = `
                    <div class="flex items-start justify-between mb-4">
                        <div class="flex-1">
                            <div class="flex items-center gap-3 mb-2">
                                <span class="px-3 py-1 bg-slate-100 text-slate-700 rounded text-sm font-medium">
                                    Question ${index + 1}
                                </span>
                                <span class="px-3 py-1 ${answer.is_correct ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'} rounded text-sm font-medium">
                                    ${answer.is_correct ? '<i class="fas fa-check-circle mr-1"></i>Correct' : '<i class="fas fa-times-circle mr-1"></i>Incorrect'}
                                </span>
                                <span class="px-3 py-1 bg-blue-100 text-blue-700 rounded text-sm font-medium">
                                    ${answer.points_earned || 0} / ${answer.question ? answer.question.points : 0} points
                                </span>
                            </div>
                            <h3 class="text-lg font-bold text-slate-800 mb-4">${escapeHtml(answer.question_text)}</h3>
                `;
                
                if (answer.question_type === 'multiple_choice') {
                    answerHtml += '<div class="space-y-2 mb-4">';
                    if (answer.options) {
                        answer.options.forEach(opt => {
                            let optionClass = 'p-3 border-2 rounded-lg ';
                            if (opt.is_correct) {
                                optionClass += 'border-green-500 bg-green-100';
                            } else if (answer.option_id === opt.id) {
                                optionClass += 'border-red-500 bg-red-100';
                            } else {
                                optionClass += 'border-slate-200 bg-white';
                            }
                            
                            answerHtml += `
                                <div class="${optionClass}">
                                    <div class="flex items-center gap-2">
                                        ${opt.is_correct ? '<i class="fas fa-check-circle text-green-600"></i>' : ''}
                                        ${answer.option_id === opt.id && !opt.is_correct ? '<i class="fas fa-times-circle text-red-600"></i>' : ''}
                                        <span>${escapeHtml(opt.option_text)}</span>
                                    </div>
                                </div>
                            `;
                        });
                    }
                    answerHtml += '</div>';
                } else {
                    answerHtml += `
                        <div class="mb-4">
                            <div class="p-4 border-2 ${answer.is_correct ? 'border-green-500 bg-green-50' : 'border-red-500 bg-red-50'} rounded-lg mb-2">
                                <div class="text-sm text-slate-600 mb-1">Your Answer:</div>
                                <div class="font-medium">${escapeHtml(answer.answer_text || answer.option_text || 'No answer provided')}</div>
                            </div>
                            <div class="p-4 border-2 border-green-500 bg-green-50 rounded-lg">
                                <div class="text-sm text-slate-600 mb-1">Correct Answer:</div>
                                <div class="font-medium">${escapeHtml(answer.correct_answer || 'N/A')}</div>
                            </div>
                        </div>
                    `;
                }
                
                answerHtml += `
                        </div>
                    </div>
                `;
                
                answerDiv.innerHTML = answerHtml;
                container.appendChild(answerDiv);
            });
        }
        
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>

