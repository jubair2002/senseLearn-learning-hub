<div class="flex h-full bg-white" data-course-id="{{ course_id }}">
    <!-- Left Sidebar - Modules with Files -->
    <div class="w-64 bg-white border-r border-slate-200 flex flex-col">
        <!-- Sidebar Header -->
        <div class="p-3 border-b border-slate-200 bg-gradient-to-r from-emerald-500 to-emerald-600">
            <div class="flex items-center gap-2">
                <div class="w-8 h-8 bg-white/20 rounded-lg flex items-center justify-center">
                    <i class="fas fa-book text-white text-sm"></i>
                </div>
                <h3 class="text-sm font-bold text-white">Course Modules</h3>
            </div>
        </div>
        
        <!-- Modules List with Files -->
        <div class="flex-1 overflow-y-auto p-3">
            {% if modules %}
                {% set first_file_processed = false %}
                {% for module in modules %}
                <div class="mb-3">
                    <!-- Module Header -->
                    <div class="module-header p-3 rounded-xl border-2 border-slate-200 bg-gradient-to-r from-white to-slate-50 hover:from-emerald-50 hover:to-emerald-100 hover:border-emerald-300 transition-all duration-200 cursor-pointer shadow-sm hover:shadow-md" onclick="toggleModule({{ module.id }})">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3 flex-1">
                                <div class="w-8 h-8 bg-emerald-100 rounded-lg flex items-center justify-center group-hover:bg-emerald-200 transition">
                                    <i class="fas fa-folder text-emerald-600 text-sm"></i>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <h4 class="font-bold text-slate-800 text-sm truncate">{{ module.name }}</h4>
                                    {% if module.description %}
                                    <p class="text-xs text-slate-500 mt-0.5 line-clamp-1">{{ module.description }}</p>
                                    {% endif %}
                                </div>
                                <i class="fas fa-chevron-down text-xs text-slate-400 module-chevron transition-transform duration-200" id="chevron-{{ module.id }}"></i>
                            </div>
                            <span class="ml-2 text-xs font-semibold text-emerald-700 bg-emerald-100 px-2 py-1 rounded-full whitespace-nowrap">{{ module.file_count }}</span>
                        </div>
                    </div>
                    
                    <!-- Module Files (Collapsible) -->
                    <div class="module-files ml-2 mt-2 space-y-2 hidden" id="files-{{ module.id }}">
                        {% if module.files and module.files|length > 0 %}
                            {% for file in module.files %}
                            <div class="file-item p-3 rounded-lg border border-slate-200 bg-white hover:bg-emerald-50 hover:border-emerald-300 hover:shadow-md transition-all duration-200 cursor-pointer group file-link" 
                                 onclick="openFile('{{ file.url }}', '{{ file.file_name }}', '{{ file.file_type }}', {{ module.id }}, {{ loop.index0 }}, {{ file.id }})"
                                 data-file-url="{{ file.url }}"
                                 data-file-name="{{ file.file_name }}"
                                 data-file-type="{{ file.file_type }}"
                                 data-file-id="{{ file.id }}">
                                <div class="flex items-start gap-3">
                                    <div class="w-10 h-10 bg-slate-100 group-hover:bg-emerald-100 rounded-lg flex items-center justify-center transition">
                                        {% if file.file_type.lower() == 'pdf' %}
                                            <i class="fas fa-file-pdf text-red-500 text-lg"></i>
                                        {% elif file.file_type.lower() in ['doc', 'docx'] %}
                                            <i class="fas fa-file-word text-blue-500 text-lg"></i>
                                        {% elif file.file_type.lower() in ['ppt', 'pptx'] %}
                                            <i class="fas fa-file-powerpoint text-orange-500 text-lg"></i>
                                        {% elif file.file_type.lower() in ['jpg', 'jpeg', 'png', 'gif'] %}
                                            <i class="fas fa-file-image text-purple-500 text-lg"></i>
                                        {% elif file.file_type.lower() in ['mp4', 'webm', 'avi', 'mov', 'mkv'] %}
                                            <i class="fas fa-file-video text-red-600 text-lg"></i>
                                        {% elif file.file_type.lower() == 'txt' %}
                                            <i class="fas fa-file-alt text-slate-500 text-lg"></i>
                                        {% else %}
                                            <i class="fas fa-file text-emerald-500 text-lg"></i>
                                        {% endif %}
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <p class="text-sm font-semibold text-slate-800 group-hover:text-emerald-800 truncate mb-1">{{ file.file_name }}</p>
                                        <div class="flex items-center gap-3 text-xs text-slate-500">
                                            <span class="bg-slate-100 px-2 py-0.5 rounded font-medium">{{ file.file_type.upper() }}</span>
                                            <span>{{ "%.1f"|format((file.file_size / 1024)) }} KB</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="p-3 text-xs text-slate-400 italic bg-slate-50 rounded-lg border border-slate-200">
                                <i class="fas fa-inbox mr-2"></i>No files in this module yet
                            </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="text-center py-12 text-slate-400">
                    <div class="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-3">
                        <i class="fas fa-folder-open text-3xl"></i>
                    </div>
                    <p class="text-sm font-medium">No modules yet</p>
                    <p class="text-xs mt-1">Modules will appear here when added</p>
                </div>
            {% endif %}
        </div>
        
    </div>
    
    <!-- Main Content Area -->
    <div class="flex-1 flex flex-col overflow-hidden bg-white">
        <!-- Content Header -->
        <div class="bg-white border-b border-slate-200 px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex-1">
                    <h1 id="content-title" class="text-2xl font-bold text-slate-800">{{ course.name }}</h1>
                </div>
                <div class="flex items-center gap-3">
                    <button id="prev-file-btn" onclick="navigateFile(-1)" class="px-4 py-2 bg-emerald-600 text-white rounded hover:bg-emerald-700 transition text-sm font-medium hidden">
                        <i class="fas fa-chevron-left mr-1"></i>Previous
                    </button>
                    <button id="next-file-btn" onclick="navigateFile(1)" class="px-4 py-2 bg-emerald-600 text-white rounded hover:bg-emerald-700 transition text-sm font-medium hidden">
                        Next<i class="fas fa-chevron-right ml-1"></i>
                    </button>
                    <button onclick="showSection('courses')" class="px-4 py-2 bg-slate-200 text-slate-700 rounded hover:bg-slate-300 transition text-sm font-medium">
                        <i class="fas fa-arrow-left mr-1"></i>Back to Courses
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Main Content Area -->
        <div class="flex-1 overflow-y-auto bg-white">
            <!-- Welcome Screen (default) -->
            <div id="welcome-screen" class="h-full p-8">
                <div class="max-w-4xl mx-auto">
                    <h2 class="text-2xl font-bold text-slate-800 mb-4">Welcome to {{ course.name }}</h2>
                    {% if course.description %}
                    <p class="text-slate-600 mb-6">{{ course.description }}</p>
                    {% endif %}
                    <p class="text-slate-600">Select a file from the left sidebar to start learning.</p>
                </div>
            </div>
            
            <!-- File Content Viewer (shown when file is selected) -->
            <div id="file-content-viewer" class="hidden h-full">
                <div id="file-content-area" class="h-full overflow-auto p-8">
                    <!-- File content will be loaded here -->
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Toggle module files visibility with smooth animation
    function toggleModule(moduleId) {
        const filesDiv = document.getElementById('files-' + moduleId);
        const chevron = document.getElementById('chevron-' + moduleId);
        
        if (filesDiv.classList.contains('hidden')) {
            filesDiv.classList.remove('hidden');
            filesDiv.style.maxHeight = filesDiv.scrollHeight + 'px';
            chevron.classList.remove('fa-chevron-down');
            chevron.classList.add('fa-chevron-up');
            chevron.style.transform = 'rotate(180deg)';
        } else {
            filesDiv.style.maxHeight = '0px';
            setTimeout(() => {
                filesDiv.classList.add('hidden');
            }, 300);
            chevron.classList.remove('fa-chevron-up');
            chevron.classList.add('fa-chevron-down');
            chevron.style.transform = 'rotate(0deg)';
        }
    }
    
    // Store all files for navigation
    let allFiles = [];
    let currentFileIndex = -1;
    let courseId = {{ course_id }};
    
    // Collect all files from sidebar
    function collectAllFiles() {
        allFiles = [];
        document.querySelectorAll('.file-link').forEach((link, index) => {
            allFiles.push({
                url: link.getAttribute('data-file-url'),
                fileName: link.getAttribute('data-file-name'),
                fileType: link.getAttribute('data-file-type'),
                fileId: link.getAttribute('data-file-id'),
                element: link
            });
        });
    }
    
    // Track file view progress
    async function trackFileView(fileId) {
        if (!fileId) return;
        
        try {
            const response = await fetch(`/student/api/progress/file/${fileId}/track`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });
            
            if (response.ok) {
                const data = await response.json();
                // Progress is tracked - will update when user returns to course list
            }
        } catch (error) {
            console.error('Error tracking file view:', error);
        }
    }
    
    // Update progress display (removed - progress is now shown on course cards)
    
    // Open file in main content area (tutorial-style)
    function openFile(url, fileName, fileType, moduleId, fileIndex, fileId) {
        // Collect all files if not done
        if (allFiles.length === 0) {
            collectAllFiles();
        }
        
        // Find current file index
        currentFileIndex = allFiles.findIndex(f => f.url === url);
        if (currentFileIndex === -1) {
            // If not found, try to find by index
            currentFileIndex = fileIndex !== undefined ? fileIndex : -1;
        }
        
        // Update active file styling
        document.querySelectorAll('.file-link').forEach(link => {
            link.classList.remove('active');
            // Reset text colors
            const textElements = link.querySelectorAll('.text-slate-800, .text-slate-500');
            textElements.forEach(el => {
                el.classList.remove('!text-white', '!text-emerald-100');
            });
            // Reset background
            const bgElements = link.querySelectorAll('.bg-slate-100');
            bgElements.forEach(el => {
                el.classList.remove('!bg-white/20', '!text-white');
            });
        });
        
        const clickedLink = document.querySelector(`[data-file-url="${url}"]`);
        if (clickedLink) {
            clickedLink.classList.add('active');
            // Update text colors for active state
            const textElements = clickedLink.querySelectorAll('.text-slate-800, .text-slate-500');
            textElements.forEach(el => {
                if (el.classList.contains('text-slate-800')) {
                    el.classList.add('!text-white');
                } else if (el.classList.contains('text-slate-500')) {
                    el.classList.add('!text-emerald-100');
                }
            });
            // Update background for active state
            const bgElements = clickedLink.querySelectorAll('.bg-slate-100');
            bgElements.forEach(el => {
                el.classList.add('!bg-white/20', '!text-white');
            });
        }
