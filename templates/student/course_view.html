<div class="flex h-full bg-white" data-course-id="{{ course_id }}">
    <!-- Left Sidebar - Modules with Files -->
    <div class="w-64 bg-white border-r border-slate-200 flex flex-col">
        <!-- Sidebar Header -->
        <div class="p-3 border-b border-slate-200 bg-gradient-to-r from-emerald-500 to-emerald-600">
            <div class="flex items-center gap-2">
                <div class="w-8 h-8 bg-white/20 rounded-lg flex items-center justify-center">
                    <i class="fas fa-book text-white text-sm"></i>
                </div>
                <h3 class="text-sm font-bold text-white">Course Modules</h3>
            </div>
        </div>
        
        <!-- Modules List with Files -->
        <div class="flex-1 overflow-y-auto p-3">
            {% if modules %}
                {% set first_file_processed = false %}
                {% for module in modules %}
                <div class="mb-3">
                    <!-- Module Header -->
                    <div class="module-header p-3 rounded-xl border-2 border-slate-200 bg-gradient-to-r from-white to-slate-50 hover:from-emerald-50 hover:to-emerald-100 hover:border-emerald-300 transition-all duration-200 cursor-pointer shadow-sm hover:shadow-md" onclick="toggleModule({{ module.id }})">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3 flex-1">
                                <div class="w-8 h-8 bg-emerald-100 rounded-lg flex items-center justify-center group-hover:bg-emerald-200 transition">
                                    <i class="fas fa-folder text-emerald-600 text-sm"></i>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <h4 class="font-bold text-slate-800 text-sm truncate">{{ module.name }}</h4>
                                    {% if module.description %}
                                    <p class="text-xs text-slate-500 mt-0.5 line-clamp-1">{{ module.description }}</p>
                                    {% endif %}
                                </div>
                                <i class="fas fa-chevron-down text-xs text-slate-400 module-chevron transition-transform duration-200" id="chevron-{{ module.id }}"></i>
                            </div>
                            <span class="ml-2 text-xs font-semibold text-emerald-700 bg-emerald-100 px-2 py-1 rounded-full whitespace-nowrap">
                                {{ module.file_count }} files{% if module.quiz_count > 0 %}, {{ module.quiz_count }} quiz{{ 'es' if module.quiz_count > 1 else '' }}{% endif %}
                            </span>
                        </div>
                    </div>
                    
                    <!-- Module Files and Quizzes (Collapsible) -->
                    <div class="module-files ml-2 mt-2 space-y-2 hidden" id="files-{{ module.id }}">
                        <!-- Files Section -->
                        {% if module.files and module.files|length > 0 %}
                            {% for file in module.files %}
                            <div class="file-item p-3 rounded-lg border border-slate-200 bg-white hover:bg-emerald-50 hover:border-emerald-300 hover:shadow-md transition-all duration-200 cursor-pointer group file-link" 
                                 onclick="openFile('{{ file.url }}', '{{ file.file_name }}', '{{ file.file_type }}', {{ module.id }}, {{ loop.index0 }}, {{ file.id }})"
                                 data-file-url="{{ file.url }}"
                                 data-file-name="{{ file.file_name }}"
                                 data-file-type="{{ file.file_type }}"
                                 data-file-id="{{ file.id }}">
                                <div class="flex items-start gap-3">
                                    <div class="w-10 h-10 bg-slate-100 group-hover:bg-emerald-100 rounded-lg flex items-center justify-center transition">
                                        {% if file.file_type.lower() == 'pdf' %}
                                            <i class="fas fa-file-pdf text-red-500 text-lg"></i>
                                        {% elif file.file_type.lower() in ['doc', 'docx'] %}
                                            <i class="fas fa-file-word text-blue-500 text-lg"></i>
                                        {% elif file.file_type.lower() in ['ppt', 'pptx'] %}
                                            <i class="fas fa-file-powerpoint text-orange-500 text-lg"></i>
                                        {% elif file.file_type.lower() in ['jpg', 'jpeg', 'png', 'gif'] %}
                                            <i class="fas fa-file-image text-purple-500 text-lg"></i>
                                        {% elif file.file_type.lower() in ['mp4', 'webm', 'avi', 'mov', 'mkv'] %}
                                            <i class="fas fa-file-video text-red-600 text-lg"></i>
                                        {% elif file.file_type.lower() == 'txt' %}
                                            <i class="fas fa-file-alt text-slate-500 text-lg"></i>
                                        {% else %}
                                            <i class="fas fa-file text-emerald-500 text-lg"></i>
                                        {% endif %}
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <p class="text-sm font-semibold text-slate-800 group-hover:text-emerald-800 truncate mb-1">{{ file.file_name }}</p>
                                        <div class="flex items-center gap-3 text-xs text-slate-500">
                                            <span class="bg-slate-100 px-2 py-0.5 rounded font-medium">{{ file.file_type.upper() }}</span>
                                            <span>{{ "%.1f"|format((file.file_size / 1024)) }} KB</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        {% endif %}
                        
                        <!-- Quizzes Section -->
                        {% if module.quizzes and module.quizzes|length > 0 %}
                            {% for quiz in module.quizzes %}
                            <div class="quiz-item p-3 rounded-lg border border-blue-200 bg-white hover:bg-blue-50 hover:border-blue-300 hover:shadow-md transition-all duration-200 group">
                                <div class="flex items-start gap-3">
                                    <div class="w-10 h-10 bg-blue-100 group-hover:bg-blue-200 rounded-lg flex items-center justify-center transition">
                                        <i class="fas fa-clipboard-list text-blue-600 text-lg"></i>
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <p class="text-sm font-semibold text-slate-800 group-hover:text-blue-800 truncate mb-1">{{ quiz.title }}</p>
                                        {% if quiz.description %}
                                        <p class="text-xs text-slate-600 mb-2 line-clamp-2">{{ quiz.description }}</p>
                                        {% endif %}
                                        <div class="flex items-center gap-3 text-xs text-slate-500 mb-2">
                                            <span><i class="fas fa-question-circle mr-1"></i>{{ quiz.question_count }} questions</span>
                                            <span><i class="fas fa-star mr-1"></i>{{ quiz.total_points }} points</span>
                                            {% if quiz.time_limit_minutes %}
                                            <span><i class="fas fa-clock mr-1"></i>{{ quiz.time_limit_minutes }} min</span>
                                            {% endif %}
                                        </div>
                                        {% if quiz.best_score is not none %}
                                        <div class="mb-2">
                                            <span class="text-xs font-semibold {% if quiz.best_score >= (quiz.passing_score or 0) %}text-green-600{% else %}text-red-600{% endif %}">
                                                Best: {{ "%.1f"|format(quiz.best_score) }}%
                                            </span>
                                        </div>
                                        {% endif %}
                                        <div class="flex gap-2 mt-2">
                                            {% if quiz.can_take %}
                                            <button onclick="startQuiz({{ quiz.id }})" class="flex-1 px-3 py-1.5 bg-emerald-600 text-white rounded text-xs font-medium hover:bg-emerald-700 transition">
                                                <i class="fas fa-play mr-1"></i>Start Quiz
                                            </button>
                                            {% else %}
                                            <button disabled class="flex-1 px-3 py-1.5 bg-slate-300 text-slate-600 rounded text-xs font-medium cursor-not-allowed">
                                                <i class="fas fa-lock mr-1"></i>Max Attempts
                                            </button>
                                            {% endif %}
                                            {% if quiz.completed_attempts > 0 %}
                                            <button onclick="viewQuizResults({{ quiz.id }})" class="px-3 py-1.5 bg-blue-600 text-white rounded text-xs font-medium hover:bg-blue-700 transition">
                                                <i class="fas fa-chart-line mr-1"></i>Results
                                            </button>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        {% endif %}
                        
                        <!-- Empty State -->
                        {% if (not module.files or module.files|length == 0) and (not module.quizzes or module.quizzes|length == 0) %}
                            <div class="p-3 text-xs text-slate-400 italic bg-slate-50 rounded-lg border border-slate-200">
                                <i class="fas fa-inbox mr-2"></i>No content in this module yet
                            </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="text-center py-12 text-slate-400">
                    <div class="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-3">
                        <i class="fas fa-folder-open text-3xl"></i>
                    </div>
                    <p class="text-sm font-medium">No modules yet</p>
                    <p class="text-xs mt-1">Modules will appear here when added</p>
                </div>
            {% endif %}
        </div>
        
    </div>
    
    <!-- Main Content Area -->
    <div class="flex-1 flex flex-col overflow-hidden bg-white">
        <!-- Content Header -->
        <div class="bg-white border-b border-slate-200 px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex-1">
                    <h1 id="content-title" class="text-2xl font-bold text-slate-800">{{ course.name }}</h1>
                </div>
                <div class="flex items-center gap-3">
                    <button id="prev-file-btn" onclick="navigateFile(-1)" class="px-4 py-2 bg-emerald-600 text-white rounded hover:bg-emerald-700 transition text-sm font-medium hidden">
                        <i class="fas fa-chevron-left mr-1"></i>Previous
                    </button>
                    <button id="next-file-btn" onclick="navigateFile(1)" class="px-4 py-2 bg-emerald-600 text-white rounded hover:bg-emerald-700 transition text-sm font-medium hidden">
                        Next<i class="fas fa-chevron-right ml-1"></i>
                    </button>
                    <button onclick="showSection('courses')" class="px-4 py-2 bg-slate-200 text-slate-700 rounded hover:bg-slate-300 transition text-sm font-medium">
                        <i class="fas fa-arrow-left mr-1"></i>Back to Courses
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Main Content Area -->
        <div class="flex-1 overflow-y-auto bg-white">
            <!-- Welcome Screen (default) -->
            <div id="welcome-screen" class="h-full p-8">
                <div class="max-w-4xl mx-auto">
                    <h2 class="text-2xl font-bold text-slate-800 mb-4">Welcome to {{ course.name }}</h2>
                    {% if course.description %}
                    <p class="text-slate-600 mb-6">{{ course.description }}</p>
                    {% endif %}
                    <p class="text-slate-600">Select a file from the left sidebar to start learning.</p>
                </div>
            </div>
            
            <!-- File Content Viewer (shown when file is selected) -->
            <div id="file-content-viewer" class="hidden h-full">
                <div id="file-content-area" class="h-full overflow-auto p-8">
                    <!-- File content will be loaded here -->
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Toggle module files visibility with smooth animation
    function toggleModule(moduleId) {
        const filesDiv = document.getElementById('files-' + moduleId);
        const chevron = document.getElementById('chevron-' + moduleId);
        
        if (filesDiv.classList.contains('hidden')) {
            filesDiv.classList.remove('hidden');
            filesDiv.style.maxHeight = filesDiv.scrollHeight + 'px';
            chevron.classList.remove('fa-chevron-down');
            chevron.classList.add('fa-chevron-up');
            chevron.style.transform = 'rotate(180deg)';
        } else {
            filesDiv.style.maxHeight = '0px';
            setTimeout(() => {
                filesDiv.classList.add('hidden');
            }, 300);
            chevron.classList.remove('fa-chevron-up');
            chevron.classList.add('fa-chevron-down');
            chevron.style.transform = 'rotate(0deg)';
        }
    }
    
    // Store all files for navigation
    let allFiles = [];
    let currentFileIndex = -1;
    let courseId = {{ course_id }};
    
    // Collect all files from sidebar
    function collectAllFiles() {
        allFiles = [];
        document.querySelectorAll('.file-link').forEach((link, index) => {
            allFiles.push({
                url: link.getAttribute('data-file-url'),
                fileName: link.getAttribute('data-file-name'),
                fileType: link.getAttribute('data-file-type'),
                fileId: link.getAttribute('data-file-id'),
                element: link
            });
        });
    }
    
    // Track file view progress
    async function trackFileView(fileId) {
        if (!fileId) return;
        
        try {
            const response = await fetch(`/student/api/progress/file/${fileId}/track`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });
            
            if (response.ok) {
                const data = await response.json();
                // Progress is tracked - will update when user returns to course list
            }
        } catch (error) {
            console.error('Error tracking file view:', error);
        }
    }
    
    // Update progress display (removed - progress is now shown on course cards)
    
    // Open file in main content area (tutorial-style)
    function openFile(url, fileName, fileType, moduleId, fileIndex, fileId) {
        // Collect all files if not done
        if (allFiles.length === 0) {
            collectAllFiles();
        }
        
        // Find current file index
        currentFileIndex = allFiles.findIndex(f => f.url === url);
        if (currentFileIndex === -1) {
            // If not found, try to find by index
            currentFileIndex = fileIndex !== undefined ? fileIndex : -1;
        }
        
        // Update active file styling
        document.querySelectorAll('.file-link').forEach(link => {
            link.classList.remove('active');
            // Reset text colors
            const textElements = link.querySelectorAll('.text-slate-800, .text-slate-500');
            textElements.forEach(el => {
                el.classList.remove('!text-white', '!text-emerald-100');
            });
            // Reset background
            const bgElements = link.querySelectorAll('.bg-slate-100');
            bgElements.forEach(el => {
                el.classList.remove('!bg-white/20', '!text-white');
            });
        });
        
        const clickedLink = document.querySelector(`[data-file-url="${url}"]`);
        if (clickedLink) {
            clickedLink.classList.add('active');
            // Update text colors for active state
            const textElements = clickedLink.querySelectorAll('.text-slate-800, .text-slate-500');
            textElements.forEach(el => {
                if (el.classList.contains('text-slate-800')) {
                    el.classList.add('!text-white');
                } else if (el.classList.contains('text-slate-500')) {
                    el.classList.add('!text-emerald-100');
                }
            });
            // Update background for active state
            const bgElements = clickedLink.querySelectorAll('.bg-slate-100');
            bgElements.forEach(el => {
                el.classList.add('!bg-white/20', '!text-white');
            });
        }
        
        // Track file view (progress updates will reflect on course cards)
        if (fileId) {
            trackFileView(parseInt(fileId));
        }
        
        // Show file in main content area
        showFileViewer(url, fileName, fileType);
        
        // Update navigation buttons
        updateNavigationButtons();
    }
    
    // Show file content in main area
    function showFileViewer(url, fileName, fileType) {
        const welcomeScreen = document.getElementById('welcome-screen');
        const fileViewer = document.getElementById('file-content-viewer');
        const fileContentArea = document.getElementById('file-content-area');
        const contentTitle = document.getElementById('content-title');
        
        if (!fileViewer || !fileContentArea) return;
        
        // Hide welcome screen, show file viewer
        welcomeScreen.classList.add('hidden');
        fileViewer.classList.remove('hidden');
        
        // Update title
        contentTitle.textContent = fileName;
        
        // Clear previous content
        fileContentArea.innerHTML = '<div class="flex items-center justify-center h-full"><div class="text-center"><i class="fas fa-spinner fa-spin text-4xl text-emerald-600 mb-4"></i><p class="text-slate-600">Loading file...</p></div></div>';
        
        // Handle different file types
        const fileTypeLower = (fileType || '').toLowerCase();
        
        if (fileTypeLower === 'pdf') {
            // PDF viewer using iframe
            const iframe = document.createElement('iframe');
            iframe.src = url;
            iframe.className = 'w-full border-0';
            iframe.style.height = 'calc(100vh - 150px)';
            fileContentArea.innerHTML = '';
            fileContentArea.appendChild(iframe);
        } else if (['jpg', 'jpeg', 'png', 'gif'].includes(fileTypeLower)) {
            // Image viewer
            const img = document.createElement('img');
            img.src = url;
            img.className = 'max-w-full h-auto mx-auto';
            img.alt = fileName;
            fileContentArea.innerHTML = '';
            fileContentArea.appendChild(img);
        } else if (['mp4', 'webm', 'avi', 'mov', 'mkv'].includes(fileTypeLower)) {
            // Video player with true streaming support (HTTP Range requests)
            const videoContainer = document.createElement('div');
            videoContainer.className = 'w-full flex flex-col items-center relative';
            
            // Loading indicator
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'absolute inset-0 flex items-center justify-center bg-slate-100 rounded-lg z-10';
            loadingDiv.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin text-4xl text-emerald-600 mb-2"></i><p class="text-slate-600">Loading video...</p></div>';
            
            const video = document.createElement('video');
            video.src = url;
            video.controls = true;
            video.preload = 'metadata'; // Load metadata only (not entire video) - allows seeking
            video.className = 'max-w-full max-h-[calc(100vh-200px)] rounded-lg shadow-lg';
            video.style.width = '100%';
            video.style.height = 'auto';
            
            // Critical: Enable streaming by preventing full buffering
            video.setAttribute('playsinline', 'true'); // For mobile
            video.setAttribute('webkit-playsinline', 'true'); // For older iOS
            
            // Add source element with proper MIME type
            const source = document.createElement('source');
            source.src = url;
            // Set proper MIME type for better browser compatibility
            const mimeTypes = {
                'mp4': 'video/mp4',
                'webm': 'video/webm',
                'avi': 'video/x-msvideo',
                'mov': 'video/quicktime',
                'mkv': 'video/x-matroska'
            };
            source.type = mimeTypes[fileTypeLower] || `video/${fileTypeLower}`;
            video.appendChild(source);
            
            // Track loading state
            let metadataLoaded = false;
            let loadTimeout = null;
            
            // Handle video loading events
            video.addEventListener('loadedmetadata', () => {
                metadataLoaded = true;
                if (loadTimeout) clearTimeout(loadTimeout);
                loadingDiv.remove();
                console.log('Video metadata loaded. Duration:', video.duration, 'seconds');
                console.log('Video ready for streaming - can seek to any position');
            });
            
            video.addEventListener('canplay', () => {
                // Video can start playing
                if (!metadataLoaded) {
                    loadingDiv.remove();
                }
            });
            
            video.addEventListener('error', (e) => {
                console.error('Video error:', e, video.error);
                if (loadTimeout) clearTimeout(loadTimeout);
                const errorMsg = video.error ? 
                    `Error ${video.error.code}: ${getVideoErrorMessage(video.error.code)}` : 
                    'Failed to load video';
                loadingDiv.innerHTML = `<div class="text-center text-red-600 p-4"><i class="fas fa-exclamation-triangle text-4xl mb-2"></i><p class="font-semibold">${errorMsg}</p><p class="text-sm mt-2">The video file may not be streamable or may be corrupted.</p><p class="text-xs mt-1 text-slate-500">Try downloading the file or contact support</p></div>`;
            });
            
            video.addEventListener('loadstart', () => {
                console.log('Video load started');
                // Set timeout to show error if metadata doesn't load
                loadTimeout = setTimeout(() => {
                    if (!metadataLoaded) {
                        loadingDiv.innerHTML = '<div class="text-center text-yellow-600 p-4"><i class="fas fa-exclamation-triangle text-4xl mb-2"></i><p>Taking longer than expected...</p><p class="text-sm mt-2">The video may not be streamable (metadata at end of file)</p><p class="text-xs mt-1">Try downloading the file or use the utility to make it streamable</p></div>';
                    }
                }, 10000); // 10 second timeout
            });
            
            // Helper function to get error messages
            function getVideoErrorMessage(errorCode) {
                const errors = {
                    1: 'MEDIA_ERR_ABORTED - Video loading aborted',
                    2: 'MEDIA_ERR_NETWORK - Network error',
                    3: 'MEDIA_ERR_DECODE - Video decoding error',
                    4: 'MEDIA_ERR_SRC_NOT_SUPPORTED - Video format not supported'
                };
                return errors[errorCode] || 'Unknown error';
            }
            
            // Handle seeking - this is where streaming happens
            video.addEventListener('seeking', () => {
                console.log('User seeking to:', video.currentTime, 'seconds');
            });
            
            video.addEventListener('seeked', () => {
                console.log('Seek completed at:', video.currentTime, 'seconds');
            });
            
            // Monitor buffering progress
            video.addEventListener('progress', () => {
                if (video.buffered.length > 0) {
                    const currentTime = video.currentTime || 0;
                    const bufferedEnd = getBufferedEnd(video, currentTime);
                    
                    if (bufferedEnd > 0) {
                        const bufferedAhead = bufferedEnd - currentTime;
                        // Log buffering info
                        if (bufferedAhead > 0) {
                            console.log('Buffered:', bufferedAhead.toFixed(1), 'seconds ahead');
                        }
                    }
                }
            });
            
            // Helper function to get buffered end time for current position
            function getBufferedEnd(videoElement, currentTime) {
                for (let i = 0; i < videoElement.buffered.length; i++) {
                    if (currentTime >= videoElement.buffered.start(i) && currentTime < videoElement.buffered.end(i)) {
                        return videoElement.buffered.end(i);
                    }
                }
                return 0;
            }
            
            videoContainer.appendChild(loadingDiv);
            videoContainer.appendChild(video);
            fileContentArea.innerHTML = '';
            fileContentArea.appendChild(videoContainer);
            
            // Monitor video buffering (logging only, no UI)
            let lastBufferedTime = 0;
            video.addEventListener('progress', () => {
                if (video.buffered.length > 0 && video.duration) {
                    const bufferedEnd = getBufferedEnd(video, video.currentTime || 0);
                    const bufferedAhead = bufferedEnd - (video.currentTime || 0);
                    
                    // Only log if buffering changed significantly
                    if (Math.abs(bufferedEnd - lastBufferedTime) > 1) {
                        lastBufferedTime = bufferedEnd;
                        // Log streaming status to console (for debugging, not shown to user)
                        if (bufferedAhead < 30 && bufferedAhead > 0) {
                            console.log(`Streaming: ${bufferedAhead.toFixed(1)}s buffered ahead`);
                        }
                    }
                }
            });
        } else if (fileTypeLower === 'txt') {
            // Text file viewer
            fetch(url)
                .then(response => response.text())
                .then(text => {
                    const pre = document.createElement('pre');
                    pre.className = 'bg-slate-900 text-slate-100 p-6 rounded overflow-auto text-sm font-mono whitespace-pre-wrap';
                    pre.style.maxHeight = 'calc(100vh - 200px)';
                    pre.textContent = text;
                    fileContentArea.innerHTML = '';
                    fileContentArea.appendChild(pre);
                })
                .catch(error => {
                    fileContentArea.innerHTML = `
                        <div class="text-center py-12 text-red-500">
                            <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
                            <p class="text-lg font-semibold">Failed to load file content</p>
                            <p class="text-sm mt-2 text-slate-600">${error.message}</p>
                        </div>
                    `;
                });
        } else if (['doc', 'docx', 'ppt', 'pptx'].includes(fileTypeLower)) {
            // Office documents
            fileContentArea.innerHTML = `
                <div class="text-center py-12">
                    <div class="w-20 h-20 bg-emerald-100 rounded-full flex items-center justify-center mx-auto mb-6">
                        <i class="fas fa-file-${fileTypeLower.includes('ppt') ? 'powerpoint' : 'word'} text-emerald-600 text-4xl"></i>
                    </div>
                    <h3 class="text-xl font-bold text-slate-800 mb-3">Office Document</h3>
                    <p class="text-slate-600 mb-6">This file type cannot be previewed in the browser.</p>
                    <a href="${url}" download="${fileName}" class="inline-flex items-center gap-2 px-6 py-3 bg-emerald-600 text-white rounded hover:bg-emerald-700 transition font-medium">
                        <i class="fas fa-download"></i>
                        Download File
                    </a>
                </div>
            `;
        } else {
            // Unknown file type
            fileContentArea.innerHTML = `
                <div class="text-center py-12">
                    <div class="w-20 h-20 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-6">
                        <i class="fas fa-file text-slate-600 text-4xl"></i>
                    </div>
                    <h3 class="text-xl font-bold text-slate-800 mb-3">File Preview Not Available</h3>
                    <p class="text-slate-600 mb-6">This file type cannot be previewed in the browser.</p>
                    <a href="${url}" download="${fileName}" class="inline-flex items-center gap-2 px-6 py-3 bg-emerald-600 text-white rounded hover:bg-emerald-700 transition font-medium">
                        <i class="fas fa-download"></i>
                        Download File
                    </a>
                </div>
            `;
        }
    }
    
    // Navigate to previous/next file
    function navigateFile(direction) {
        if (allFiles.length === 0 || currentFileIndex === -1) return;
        
        const newIndex = currentFileIndex + direction;
        if (newIndex >= 0 && newIndex < allFiles.length) {
            const file = allFiles[newIndex];
            // Find module ID and file index from the element
            const element = file.element;
            const moduleId = element.closest('.module-files')?.id.replace('files-', '');
            const fileIndex = Array.from(element.parentElement.children).indexOf(element);
            openFile(file.url, file.fileName, file.fileType, moduleId, fileIndex, file.fileId);
        }
    }
    
    // Update navigation buttons visibility
    function updateNavigationButtons() {
        const prevBtn = document.getElementById('prev-file-btn');
        const nextBtn = document.getElementById('next-file-btn');
        
        if (prevBtn && nextBtn) {
            if (allFiles.length > 1 && currentFileIndex !== -1) {
                prevBtn.classList.remove('hidden');
                nextBtn.classList.remove('hidden');
                prevBtn.disabled = currentFileIndex === 0;
                nextBtn.disabled = currentFileIndex === allFiles.length - 1;
            } else {
                prevBtn.classList.add('hidden');
                nextBtn.classList.add('hidden');
            }
        }
    }
    
    // Close file viewer and show welcome screen
    function closeFileViewer() {
        const welcomeScreen = document.getElementById('welcome-screen');
        const fileViewer = document.getElementById('file-content-viewer');
        const contentTitle = document.getElementById('content-title');
        const prevBtn = document.getElementById('prev-file-btn');
        const nextBtn = document.getElementById('next-file-btn');
        
        if (welcomeScreen) welcomeScreen.classList.remove('hidden');
        if (fileViewer) fileViewer.classList.add('hidden');
        if (contentTitle) contentTitle.textContent = '{{ course.name }}';
        if (prevBtn) prevBtn.classList.add('hidden');
        if (nextBtn) nextBtn.classList.add('hidden');
        
        // Remove active styling
        document.querySelectorAll('.file-link').forEach(link => {
            link.classList.remove('active');
            // Reset text colors
            const textElements = link.querySelectorAll('.text-slate-800, .text-slate-500');
            textElements.forEach(el => {
                el.classList.remove('!text-white', '!text-emerald-100');
            });
            // Reset background
            const bgElements = link.querySelectorAll('.bg-slate-100');
            bgElements.forEach(el => {
                el.classList.remove('!bg-white/20', '!text-white');
            });
        });
        
        currentFileIndex = -1;
    }
    
    // Auto-expand first module on load (but don't auto-load first file)
    (function() {
        setTimeout(() => {
            const firstModule = document.querySelector('.module-header');
            if (firstModule) {
                const moduleId = firstModule.getAttribute('onclick').match(/\d+/)[0];
                toggleModule(moduleId);
            }
        }, 300);
    })();
    
    // Quiz functions
    window.startQuiz = async function(quizId) {
        try {
            const response = await fetch(`/quiz/api/quizzes/${quizId}/start`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });
            
            const data = await response.json();
            
            if (data.success) {
                // Load quiz taking interface
                loadQuizInterface(data.attempt.id);
            } else {
                alert(data.error || 'Failed to start quiz');
            }
        } catch (error) {
            console.error('Error starting quiz:', error);
            alert('Error starting quiz. Please try again.');
        }
    };
    
    window.viewQuizResults = async function(quizId) {
        try {
            // Get all attempts for this quiz
            const response = await fetch(`/quiz/api/quizzes/${quizId}/attempts`);
            
            let data;
            try {
                data = await response.json();
            } catch (jsonError) {
                console.error('Failed to parse JSON response:', jsonError);
                const text = await response.text();
                console.error('Response text:', text);
                throw new Error(`Server error (${response.status}): ${text.substring(0, 100)}`);
            }
            
            if (!response.ok) {
                const errorMsg = data.error || data.message || `HTTP error! status: ${response.status}`;
                console.error('Server error:', errorMsg);
                alert(`Error: ${errorMsg}`);
                return;
            }
            
            if (data.success && data.attempts && data.attempts.length > 0) {
                // Find the most recent completed attempt
                const completedAttempts = data.attempts.filter(a => a.is_completed);
                if (completedAttempts.length > 0) {
                    // Redirect to results page for the most recent attempt (first one is already sorted by submitted_at desc)
                    window.location.href = `/student/quiz/${completedAttempts[0].id}/results`;
                } else {
                    alert('No completed attempts found for this quiz. Please complete a quiz attempt first.');
                }
            } else {
                alert('No quiz attempts found. Please start and complete a quiz first.');
            }
        } catch (error) {
            console.error('Error loading quiz results:', error);
            alert(`Error loading quiz results: ${error.message || 'Please try again.'}`);
        }
    };
    
    async function loadQuizInterface(attemptId) {
        try {
            const response = await fetch(`/quiz/api/attempts/${attemptId}/questions`);
            const data = await response.json();
            
            if (data.success) {
                // Redirect to quiz taking page
                window.location.href = `/student/quiz/${attemptId}`;
            } else {
                alert(data.error || 'Failed to load quiz');
            }
        } catch (error) {
            console.error('Error loading quiz:', error);
            alert('Error loading quiz. Please try again.');
        }
    }
    
    function showQuizTakingInterface(quizData, attemptId) {
        // This will be implemented in a separate quiz-taking template
        // For now, redirect to a dedicated quiz page
        window.location.href = `/student/quiz/${attemptId}`;
    }
</script>

<style>
    .module-files {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease-out, opacity 0.2s ease-out;
        opacity: 0;
    }
    
    .module-files:not(.hidden) {
        opacity: 1;
    }
    
    .module-chevron {
        transition: transform 0.3s ease-out;
    }
    
    .file-link.active {
        background-color: #059669 !important;
        border-color: #047857 !important;
    }
    
    .file-link.active .text-slate-800 {
        color: white !important;
    }
    
    .file-link.active .text-slate-500 {
        color: #d1fae5 !important;
    }
    
    .file-link.active .bg-slate-100 {
        background-color: rgba(255, 255, 255, 0.2) !important;
        color: white !important;
    }
    
    .file-link.active:hover {
        background-color: #047857 !important;
    }
    
    /* Smooth scrollbar */
    .overflow-y-auto::-webkit-scrollbar {
        width: 6px;
    }
    
    .overflow-y-auto::-webkit-scrollbar-track {
        background: #f1f5f9;
    }
    
    .overflow-y-auto::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 3px;
    }
    
    .overflow-y-auto::-webkit-scrollbar-thumb:hover {
        background: #94a3b8;
    }
</style>

<script>
    // Close viewer on escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeFileViewer();
        }
    });
</script>
